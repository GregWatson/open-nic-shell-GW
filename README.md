# AMD OpenNIC Shell - Greg's modified version

This is a fork of Xilinx's https://github.com/Xilinx/open-nic-shell - see that first for background information

This is a copy of the open-nic-shell verilog, and it adds the Xilinx DDR4 controller generated by the MIG 2.0 generator. It is specific for the Au250 board.
The sole purpose is to understand how you might add the DDR Controller to the opne-nic-shell.

The original Xilinx logic provides user-definable boxes called the box_250mhz and the box_322mhz. In this project we add some logic to the box_250mhz block. This logic provides some registers that allow us to write and read data to/from one 16GB bank of DDR memory on the Au250 board.

It might help to see the diagram in the file ddr4_ip.pdf in the repo.

## New logic

The logic added in order is:
- loop_lite_slave.sv - this attaches to the 'dummy' bus of the box_250mhz_address_map block which provides address decoding for the box_250mhz block. In the Xilinx version the dummy bus is not used.
- axi-lite-register - this instantiates a xilinx block that converts AXI-lite to a very simple read/write protocol.
- loop_registers.sv - this handles the clock domain crossings between the 250MHz of the box_250mhz and the 300MHz of the DDR4 IP application interface.
- loop_ddr_ctrl.sv - this provides some registers to perform some very simple block writes and block reads to/from the DDR.
- ddr4_0 - this is the actual DDR4 controller generated by the Memory Intreface Generator. This Xilinx IP is generated under the control of a ddr4_o.xci file. The IP interfaces to one external bank of 16GB of DDR4 RAM in a x72b configuration. The Au250 board has 4 banks - a separate controller is needed for each bank. This design uses just the one bank of 16GB.

The new logic is in the plugin/loop directory. This replaces the standard p2p plugin (although most of it remians identical)

The IP definition file (.xci) for the DDR4 controller is in `src/ddr4/ddr4_0.xci`

## Synthesis
The synthesis script (script/build.tcl) has been modified to include the DDR4 controller. See these added lines:

`# Read DDR IP which is already in .xci`
`puts "Reading ddr4 IP from ${src_dir}/ddr4/ddr4_0.xci"`
`read_ip ${src_dir}/ddr4/ddr4_0.xci`

The constraint files modified include:
`constr/au250/pins.xdc` - to add the DDR4 pins
`constr/au250/timing.xdc` - to add the requisite clock information

To synthesize you need to give the path to the new plugin:
`cd scripts`
`vivado -mode tcl -source build.tcl -tclargs -board au250 -impl 1 -user_plugin [your-path-to_open-nic-shell-GW-directory]/plugin/loop/ -num_cmac_port 2 -num_phys_func 2`
